<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>DeadlineNoon â€” Survivor</title>
<style>
:root{--bg:#0f1115;--panel:#151826;--ink:#e7e9ee;--muted:#9aa3b2;--accent:#7c5cff;--line:#262a3b;--good:#2ecc71;--bad:#ff6b6b;--warn:#f1c40f;--info:#4da3ff}
*{box-sizing:border-box}body{margin:0;background:var(--bg);color:var(--ink);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial}
.wrap{max-width:1300px;margin:0 auto;padding:24px}
header{display:flex;justify-content:space-between;align-items:center;gap:12px;margin-bottom:16px}
.brand{font-weight:800;font-size:28px}.accent{color:var(--accent)}
.badge{border:1px solid var(--line);border-radius:999px;padding:6px 10px;color:var(--muted);font-size:12px}
.grid{display:grid;gap:16px}@media(min-width:1200px){.grid{grid-template-columns:2fr 1fr}}
.card{background:linear-gradient(180deg,rgba(255,255,255,.02),rgba(0,0,0,.08)),var(--panel);border:1px solid var(--line);border-radius:16px;padding:16px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
h2{margin:0 0 10px}.sub{color:var(--muted);font-size:14px}
.row{display:flex;align-items:center;justify-content:space-between;gap:8px;flex-wrap:wrap}
.controls{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
select,textarea,button,input{background:rgba(255,255,255,.04);border:1px solid var(--line);color:var(--ink);padding:8px 10px;border-radius:10px;font:inherit}
button{cursor:pointer}
input{min-width:0}
table{width:100%;border-collapse:collapse}th,td{padding:10px;border-bottom:1px solid var(--line);vertical-align:middle}
th{text-align:left;font-size:12px;letter-spacing:.3px;text-transform:uppercase;color:var(--muted)}
tr:last-child td{border-bottom:0}
.mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
.pill{display:inline-flex;align-items:center;gap:6px;border:1px solid var(--line);border-radius:999px;padding:4px 10px;font-size:12px}
.chip{display:inline-block;border:1px solid var(--line);border-radius:999px;padding:2px 8px;font-size:12px}
.chip.warn{color:var(--warn)}.chip.info{color:var(--info)}.chip.ok{color:var(--good)}.chip.bad{color:var(--bad)}
.muted{color:var(--muted)}footer{margin-top:16px;color:var(--muted);font-size:12px;text-align:center}
.scroll{max-height:520px;overflow:auto;border:1px solid var(--line);border-radius:12px}
.tiny{font-size:12px}
.legend{display:flex;gap:8px;flex-wrap:wrap}.legend .chip{border-style:dashed}
/* Compact tracker */
.trk-compact .rowline{display:grid;grid-template-columns:1fr auto;gap:8px;align-items:center}
.used-mini{display:flex;flex-wrap:wrap;gap:6px}
.u-chip{display:inline-flex;align-items:center;gap:6px;padding:2px 8px;border:1px solid var(--line);border-radius:999px;background:rgba(255,255,255,.03)}
.u-chip .wk{font-size:11px;color:var(--muted)}
.toggle-btn{display:inline-flex;align-items:center;gap:6px;border:1px solid var(--line);border-radius:10px;padding:4px 10px;background:rgba(255,255,255,.04);color:var(--ink);cursor:pointer;font-size:12px}
.toggle-btn .chev{transition:transform .18s ease}
.toggle-btn[aria-expanded="true"] .chev{transform:rotate(90deg)}
.link-btn{background:none;border:0;padding:0;font:inherit;color:var(--accent);cursor:pointer;text-decoration:underline}
.link-btn:hover,.link-btn:focus{color:#fff}
.open-panel{color:var(--muted)}
.open-panel:hover,.open-panel:focus{color:var(--ink)}
.trk-panel{overflow:hidden;max-height:0;opacity:0;transition:max-height .25s ease,opacity .2s ease;background:linear-gradient(180deg,rgba(255,255,255,.02),rgba(0,0,0,.08));border:1px solid var(--line);border-radius:12px;margin:8px 0;padding:0 12px}
.trk-panel.open{max-height:260px;opacity:1;padding:12px}
.trk-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.trk-col h4{margin:0 0 6px;font-size:12px;color:var(--muted);letter-spacing:.3px;text-transform:uppercase}
.chips{display:flex;flex-wrap:wrap;gap:6px}
.right-meta{display:flex;gap:8px;align-items:center}
.mutey{color:var(--muted);font-size:12px}
.logo{height:20px;width:20px;vertical-align:-4px;margin-right:6px;border-radius:2px;background:#0002}
.logo-lg{height:28px;width:28px;vertical-align:-6px;margin-right:8px;border-radius:4px;background:#0002}
.badge-inline{display:inline-flex;align-items:center;gap:6px}
.kit{display:flex;flex-wrap:wrap;gap:6px}
.kit .tile{display:flex;align-items:center;gap:6px;border:1px solid var(--line);border-radius:10px;padding:4px 8px}
.kit .used{opacity:.35}
/* Hedge tab */
.hedge-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.box{border:1px solid var(--line);border-radius:12px;padding:12px;background:rgba(255,255,255,.03)}
.label{font-size:12px;color:var(--muted);margin-bottom:6px}
.stack{display:flex;flex-direction:column;gap:8px}
.row-gap{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
.num{font-weight:700}
.hidden{display:none}
.warn{color:var(--warn)}
.note{font-size:12px;color:var(--muted)}
/* Tabs */
.tabs{display:flex;gap:8px;margin:0 0 12px}
.tabbtn{border:1px solid var(--line);border-radius:999px;padding:6px 12px;background:rgba(255,255,255,.03);cursor:pointer;color:var(--ink)}
.tabbtn.active{outline:2px solid var(--accent)}
.tabpage{display:none}
.tabpage.active{display:block}
.special-flag{display:inline-flex;align-items:center;gap:4px;margin-left:4px}
.special-toggle{background:rgba(255,255,255,.04);border:1px solid var(--line);color:var(--ink);width:22px;height:22px;border-radius:50%;display:inline-flex;align-items:center;justify-content:center;font-size:14px;line-height:1;padding:0;cursor:pointer}
.special-panel{display:none;margin:6px 0 0;padding:6px 8px;border:1px solid var(--line);border-radius:10px;background:rgba(255,255,255,.03);gap:6px;flex-wrap:wrap}
.special-panel.open{display:flex}
.special-team{display:inline-flex;align-items:center;gap:4px;padding:2px 6px;border:1px solid var(--line);border-radius:999px;font-size:12px}
.special-team.used{opacity:.35}
.special-games-wrap{margin-top:12px}
.special-games-group{margin-bottom:12px}
.special-games-row{display:flex;flex-wrap:wrap;gap:12px}
.game-card{flex:1 1 220px;min-width:200px;background:rgba(255,255,255,.04);border:1px solid var(--line);border-radius:12px;padding:12px;display:flex;flex-direction:column;gap:10px}
.game-header{display:flex;align-items:center;gap:8px;font-size:12px;color:var(--muted)}
.game-icon{font-size:20px}
.game-body{display:flex;flex-direction:column;gap:6px}
.game-team{display:flex;align-items:center;gap:6px;font-weight:600}
.game-team.used{opacity:.35}
.special-focus-note{font-size:11px;color:var(--muted)}
.game-at{font-size:11px;color:var(--muted);text-align:center;letter-spacing:.6px;text-transform:uppercase}
#specialStatus tbody tr.focus td{background:rgba(255,255,255,.05)}
.chip.logo-chip{display:inline-flex;align-items:center;gap:6px;padding-right:10px}
.chip.dim{opacity:.35}
.chip .logo{margin-right:0}
.toggle-btn .chev{display:inline-block;transition:transform .2s ease}
.toggle-btn[aria-expanded="true"] .chev{transform:rotate(90deg)}
.avail-panel{display:none;margin-top:8px;padding:12px;border:1px solid var(--line);border-radius:12px;background:rgba(255,255,255,.03)}
.avail-panel.open{display:block}
.avail-grid{display:flex;flex-wrap:wrap;gap:16px}
.avail-col{flex:1 1 220px;min-width:200px}
.avail-col h4{margin:0 0 6px;font-size:13px;text-transform:uppercase;letter-spacing:.6px;color:var(--muted)}
.chips{display:flex;flex-wrap:wrap;gap:6px}
.chips .chip{border-style:dashed}
.root-card .kpis{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-top:8px}
.kpi{border:1px solid var(--line);border-radius:12px;padding:10px;background:rgba(255,255,255,.03)}
.kpi .n{font-weight:700}
.root-table{width:100%;border-collapse:collapse;margin-top:8px}
.root-table th,.root-table td{padding:8px;border-bottom:1px solid var(--line)}
.root-table .used{opacity:.35}
.badge-good{color:var(--good)}
.badge-bad{color:var(--bad)}
.badge-warn{color:var(--warn)}
.ifttt{margin-top:10px;border:1px dashed var(--line);border-radius:12px;padding:10px}
.profit{color:var(--good)}
.loss{color:var(--bad)}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div>
      <div class="badge">Week <span id="hdr-week"></span> â€¢ <span id="hdr-date"></span></div>
      <div class="brand">Deadline<span class="accent">Noon</span> â€” Survivor</div>
      <div class="sub">9 contestants â€¢ ties = loss â€¢ special weeks â€¢ 40% special-usage alerts â€¢ real logos</div>
    </div>
    <div class="badge mono" id="env-badge"></div>
  </header>

  <!-- Tabs -->
  <div class="tabs">
    <button class="tabbtn active" data-tab="overview">Overview</button>
    <button class="tabbtn" data-tab="rooting">Rooting</button>
    <button class="tabbtn" data-tab="hedge">Hedge</button>
  </div>

  <!-- ====== OVERVIEW PAGE ====== -->
  <div id="tab-overview" class="tabpage active">
  <div class="grid">
    <!-- LEFT: Tracker -->
    <section class="card">
      <div class="row">
        <div>
          <h2>Survivor Tracker</h2>
          <div class="legend">
            <span class="chip ok tiny">ACTIVE</span>
            <span class="chip bad tiny">ELIMINATED</span>
            <span class="chip warn tiny">About to pass 40% (special)</span>
            <span class="chip info tiny">â‰¥40% used (special)</span>
          </div>
        </div>
        <div class="controls">
          <label class="tiny muted">Week <select id="weekSelect"></select></label>
          <button id="advanceWeek">Advance âžœ</button>
          <span class="pill mono" id="activeCount"></span>
          <span class="pill mono" id="weekType"></span>
        </div>
      </div>

      <div class="scroll" style="margin-top:10px">
        <div class="mutey" id="densityWrap">
          <label class="tiny muted">Density
            <select id="trkDensity">
              <option value="comfort">Comfort</option>
              <option value="compact">Compact</option>
            </select>
          </label>
        </div>
        <table id="tracker" class="trk-compact">
          <thead><tr><th>Player</th><th class="mono" style="text-align:right">Summary</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>

      <h3 style="margin-top:16px">Special Week Readiness</h3>
      <div class="tiny muted" style="margin-bottom:6px">If a player has no eligible team from a special set at that week, theyâ€™re auto-eliminated.</div>
      <div class="scroll">
        <table id="specialStatus">
          <thead><tr><th>Player</th><th>TG+BF</th><th></th><th>Christmas</th><th></th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
      <div id="specialGameCards" class="special-games-wrap"></div>
    </section>

    <!-- RIGHT: Rules + Make Picks -->
    <section class="card">
      <div class="row"><h2>Rules</h2><span class="chip">Implemented</span></div>
      <ul class="tiny">
        <li>Pick one team weekly; <strong>no reuse</strong> per entry.</li>
        <li><strong>Ties = losses</strong> (elimination).</li>
        <li><strong>Special weeks</strong> are independent: picks must come from that weekâ€™s set (TG+BF / XMAS).</li>
        <li>Auto-elimination at a special week if no team left from that set.</li>
        <li><strong>40% special-usage alerts</strong> (popup + badges): TG threshold 4/8; XMAS threshold 3/6.</li>
      </ul>

      <h3 style="margin-top:10px">Make Picks (Weeks 4+ or remaining W3)</h3>
      <div class="tiny muted" style="margin-bottom:6px">Choose a week, entry, then an <strong>available</strong> team (logos shown). Saved picks persist locally.</div>
      <div class="controls" style="margin-bottom:8px">
        <label class="tiny muted">Week
          <select id="pickWeek"></select>
        </label>
        <label class="tiny muted">Entry
          <select id="pickPlayer"></select>
        </label>
        <label class="tiny muted">Team
          <select id="pickTeam"></select>
        </label>
        <button id="savePick">Save Pick</button>
      </div>
      <div id="availabilityTiles" class="kit"></div>

      <details style="margin-top:12px">
        <summary><strong>Data (read-only seed below; your edits persist locally)</strong></summary>
        <textarea id="dataEditor" rows="12" spellcheck="false" style="width:100%"></textarea>
      </details>
    </section>
  </div>
  </div><!-- /tab-overview -->

  <!-- ====== ROOTING PAGE ====== -->
  <div id="tab-rooting" class="tabpage">
  <section class="card root-card" id="rooting">
    <div class="row">
      <h2>Rooting Guide &amp; IFTTT</h2>
      <span class="chip">Week <span id="root-week"></span></span>
    </div>
    <div class="kpis">
      <div class="kpi"><div class="tiny muted">Group using chalk team</div><div class="n mono" id="kpi-chalk"></div></div>
      <div class="kpi"><div class="tiny muted">Field on chalk</div><div class="n mono" id="kpi-field"></div></div>
      <div class="kpi"><div class="tiny muted">If chalk loses â†’ field out</div><div class="n mono badge-good" id="kpi-chalklose"></div></div>
    </div>
    <h3 style="margin-top:12px">Best Outcomes (Leverage)</h3>
    <table class="root-table" id="root-table">
      <thead><tr>
        <th>Outcome</th><th class="mono">% Field Impact</th><th class="mono">Group Exposure</th><th>Why it helps</th>
      </tr></thead>
      <tbody></tbody>
    </table>
    <div class="ifttt" id="ifttt"></div>
  </section>
  </div><!-- /tab-rooting -->

  <!-- ====== HEDGE PAGE ====== -->
  <div id="tab-hedge" class="tabpage">
  <section class="card" id="hedge">
    <div class="row">
      <h2>Hedge</h2>
      <div class="row-gap">
        <label class="tiny muted">Entry
          <select id="hedgePlayer"></select>
        </label>
        <label class="tiny muted">Week
          <select id="hedgeWeek"></select>
        </label>
        <span class="pill mono" id="hedgeBadges"></span>
      </div>
    </div>

    <div class="hedge-grid" style="margin-top:10px">
      <div class="box">
        <div class="label">Current Pick &amp; History</div>
        <div id="hedgePick" class="stack"></div>
        <div class="note" style="margin-top:6px">
          <strong>Hedge Instructions (American odds only):</strong>
          <ol class="tiny" style="margin:6px 0 0 16px">
            <li>Pick your Entry and Week.</li>
            <li>Opponent moneyline (American) auto-fills â€” edit if you have a better price.</li>
            <li>Set Entry equity if win (default $1105) and Buy-in (default $1300). Add a Target floor if you want one.</li>
            <li>Click <strong>Equalize Outcomes</strong> (same net both ways), <strong>Hit Target Floor</strong> (guarantee â‰¥ floor), or <strong>Lock Buy-In</strong> (guarantee at least your $1300).</li>
            <li>Review the table to see hedge net, net after buy-in, and EV.</li>
          </ol>
        </div>
      </div>
      <div class="box">
        <div class="label">Hedge Calculator</div>
        <div class="stack">
          <div class="tiny muted">Enter opponent <strong>American</strong> moneyline (e.g., +150, -120). No decimals shown.</div>
          <div class="row-gap">
            <label class="tiny muted">Opp. ML (American)
              <input id="hcAmer" type="number" step="1" placeholder="+150" />
            </label>
            <label class="tiny muted">Stake ($)
              <input id="hcStake" type="number" min="0" step="1" value="50" />
            </label>
            <label class="tiny muted">Win chance for your pick (%)
              <input id="hcPwin" type="number" min="1" max="99" step="1" value="60" />
            </label>
            <label class="tiny muted">Entry equity if win ($)
              <input id="hcEquity" type="number" min="0" step="1" value="1105" />
            </label>
            <label class="tiny muted">Buy-in ($)
              <input id="hcBuyin" type="number" min="0" step="1" value="1300" />
            </label>
            <label class="tiny muted">Target floor ($)
              <input id="hcFloor" type="number" min="0" step="1" value="150" />
            </label>
            <label class="tiny muted">Desired profit ($)
              <input id="hcProfit" type="number" min="0" step="1" value="200" />
            </label>
          </div>
          <div class="row-gap">
            <button id="btnEqualize" class="toggle-btn" type="button"><span>Equalize Outcomes</span></button>
            <button id="btnTarget" class="toggle-btn" type="button"><span>Hit Target Floor</span></button>
            <button id="btnLock" class="toggle-btn" type="button"><span>Lock Buy-In</span></button>
            <button id="btnProfit" class="toggle-btn" type="button"><span>Lock $ Profit</span></button>
          </div>
          <span id="hcWarn" class="note"></span>
          <table class="root-table" id="hcTable">
            <thead><tr><th>Scenario</th><th class="mono">Net from hedge</th><th class="mono">Net after buy-in</th><th class="mono">EV (given %)</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>
  </section>

  <!-- Week Lines (American ML) editor -->
  <section class="card" style="margin-top:12px">
    <div class="row">
      <h2>Week Lines (American ML)</h2>
      <span class="chip">Paste current week moneylines as JSON</span>
    </div>
    <div class="tiny muted" style="margin:6px 0 8px">
      Schema: { "3": { "IND@TEN": {"home":"TEN","away":"IND","ml":{"IND":+140,"TEN":-165}} } } â€¢ Paste your latest numbers any time.
    </div>
    <textarea id="linesEditor" rows="8" spellcheck="false" style="width:100%"></textarea>
    <div class="row" style="margin-top:8px">
      <div class="row-gap">
        <button id="applyLines" class="toggle-btn" type="button">Save Lines âœ…</button>
        <button id="resetLines" class="toggle-btn" type="button">Reset to Blank â†º</button>
      </div>
      <span class="note">Hedge autocompletes opponent ML when a pick exists for that week.</span>
    </div>
  </section>
  </div><!-- /tab-hedge -->

  <footer>Â© <span id="year"></span> DeadlineNoon â€” Survivor</footer>
</div>

<script>
/* ===== Logos & Teams ===== */
const ESPN = {"ARI":"ari","ATL":"atl","BAL":"bal","BUF":"buf","CAR":"car","CHI":"chi","CIN":"cin","CLE":"cle","DAL":"dal","DEN":"den","DET":"det","GB":"gb","HOU":"hou","IND":"ind","JAX":"jac","KC":"kc","LV":"lv","LAC":"lac","LAR":"lar","MIA":"mia","MIN":"min","NE":"ne","NO":"no","NYG":"nyg","NYJ":"nyj","PHI":"phi","PIT":"pit","SEA":"sea","SF":"sf","TB":"tb","TEN":"ten","WAS":"wsh"};
const TEAM_NAME = {"ARI":"Cardinals","ATL":"Falcons","BAL":"Ravens","BUF":"Bills","CAR":"Panthers","CHI":"Bears","CIN":"Bengals","CLE":"Browns","DAL":"Cowboys","DEN":"Broncos","DET":"Lions","GB":"Packers","HOU":"Texans","IND":"Colts","JAX":"Jaguars","KC":"Chiefs","LV":"Raiders","LAC":"Chargers","LAR":"Rams","MIA":"Dolphins","MIN":"Vikings","NE":"Patriots","NO":"Saints","NYG":"Giants","NYJ":"Jets","PHI":"Eagles","PIT":"Steelers","SEA":"Seahawks","SF":"49ers","TB":"Buccaneers","TEN":"Titans","WAS":"Commanders"};
const NFL = Object.keys(TEAM_NAME);
const logo = c => `https://a.espncdn.com/i/teamlogos/nfl/500/${ESPN[c]}.png`;

/* ===== Special Weeks ===== */
const TG_BF = ["GB","DET","KC","DAL","CIN","BAL","CHI","PHI"]; // 8
const XMAS  = ["DAL","WAS","DET","MIN","DEN","KC"];            // 6
const SPECIAL_THRESHOLD = 0.40;
const TG_THRESHOLD = Math.ceil(TG_BF.length * SPECIAL_THRESHOLD);   // 4
const XMAS_THRESHOLD = Math.ceil(XMAS.length  * SPECIAL_THRESHOLD); // 3
const SPECIAL_GAME_GROUPS = [
  {
    key:"TG_BF",
    title:"Thanksgiving & Black Friday Slate",
    games:[
      {tag:"TG", date:"Thu â€¢ Nov 27", time:"12:30p ET", away:"GB", home:"DET"},
      {tag:"TG", date:"Thu â€¢ Nov 27", time:"4:30p ET", away:"KC", home:"DAL"},
      {tag:"TG", date:"Thu â€¢ Nov 27", time:"8:20p ET", away:"CIN", home:"BAL"},
      {tag:"BF", date:"Fri â€¢ Nov 28", time:"3:00p ET", away:"CHI", home:"PHI"}
    ]
  },
  {
    key:"XMAS",
    title:"Christmas Slate",
    games:[
      {tag:"XMAS", date:"Thu â€¢ Dec 25", time:"1:00p ET", away:"MIN", home:"DET"},
      {tag:"XMAS", date:"Thu â€¢ Dec 25", time:"4:30p ET", away:"WAS", home:"DAL"},
      {tag:"XMAS", date:"Thu â€¢ Dec 25", time:"8:15p ET", away:"DEN", home:"KC"}
    ]
  }
];
const TG_MATCHUP_TAG = {
  GB:"GB@DET",
  DET:"GB@DET",
  KC:"KC@DAL",
  DAL:"KC@DAL",
  CIN:"CIN@BAL",
  BAL:"CIN@BAL",
  CHI:"CHI@PHI",
  PHI:"CHI@PHI"
};
const XMAS_MATCHUP_TAG = {
  DAL:"DAL vs WAS",
  WAS:"DAL vs WAS",
  DET:"DET vs MIN",
  MIN:"DET vs MIN",
  DEN:"DEN vs KC",
  KC:"DEN vs KC"
};

/* ===== Seeded Data (W1â€“W3) ===== */
/* Results: W=win, L=loss, T=tie, P=pending */
const STARTER = {
  meta: {
    season: 2025,
    currentWeek: 3,
    weekDates: {
      "1":"2025-09-07","2":"2025-09-14","3":"2025-09-21",
      "4":"2025-09-28","5":"2025-10-05","6":"2025-10-12","7":"2025-10-19","8":"2025-10-26",
      "9":"2025-11-02","10":"2025-11-09","11":"2025-11-16","12":"2025-11-23",
      "TG":"2025-11-27","13":"2025-11-30","14":"2025-12-07","15":"2025-12-14",
      "XMAS":"2025-12-25","16":"2025-12-28","17":"2026-01-04"
    }
  },
  players: [
    {name:"Cremaster Reflex 1"},
    {name:"Cremaster Reflex 2"},
    {name:"BulletProof Tiger 1"},
    {name:"BulletProof Tiger 2"},
    {name:"BulletProof Tiger 3"},
    {name:"ChiPhi 1"},
    {name:"Creamsicle Cabana"},
    {name:"Gambling Grocer-7"},
    {name:"SlyBiz"}
  ],
  picks: [
    // Week 1 (per sheet)
    {week:1, player:"SlyBiz",               team:"ARI", result:"P"},
    {week:1, player:"Cremaster Reflex 1",   team:"ARI", result:"P"},
    {week:1, player:"Cremaster Reflex 2",   team:"DEN", result:"P"},
    {week:1, player:"BulletProof Tiger 1",  team:"DEN", result:"P"},
    {week:1, player:"BulletProof Tiger 2",  team:"DEN", result:"P"},
    {week:1, player:"BulletProof Tiger 3",  team:"ARI", result:"P"},
    {week:1, player:"ChiPhi 1",             team:"JAX", result:"P"},
    {week:1, player:"Gambling Grocer-7",    team:"CIN", result:"P"},
    {week:1, player:"Creamsicle Cabana",    team:"WAS", result:"P"},

    // Week 2
    {week:2, player:"SlyBiz",               team:"DAL", result:"P"},
    {week:2, player:"Cremaster Reflex 1",   team:"LAR", result:"P"},
    {week:2, player:"Cremaster Reflex 2",   team:"ARI", result:"P"},
    {week:2, player:"BulletProof Tiger 1",  team:"ARI", result:"P"},
    {week:2, player:"BulletProof Tiger 2",  team:"BAL", result:"P"},
    {week:2, player:"BulletProof Tiger 3",  team:"DAL", result:"P"},
    {week:2, player:"ChiPhi 1",             team:"DET", result:"P"},
    {week:2, player:"Gambling Grocer-7",    team:"DET", result:"P"},
    {week:2, player:"Creamsicle Cabana",    team:"DAL", result:"P"},

    // Week 3 (BUF = WIN Thu)
    {week:3, player:"SlyBiz",               team:"GB",  result:"P"},
    {week:3, player:"Cremaster Reflex 1",   team:"SEA", result:"P"},
    {week:3, player:"Cremaster Reflex 2",   team:"TB",  result:"P"},
    {week:3, player:"BulletProof Tiger 1",  team:"KC",  result:"P"},
    {week:3, player:"BulletProof Tiger 2",  team:"SEA", result:"P"},
    {week:3, player:"BulletProof Tiger 3",  team:"BUF", result:"W"},
    {week:3, player:"ChiPhi 1",             team:"KC",  result:"P"},
    {week:3, player:"Gambling Grocer-7",    team:"KC",  result:"P"},
    {week:3, player:"Creamsicle Cabana",    team:"SEA", result:"P"}
  ]
};

/* ===== Persistence ===== */
const LS_KEY = "deadlineNoon_survivor_v4";
function loadData(){ try{ const raw=localStorage.getItem(LS_KEY); if(raw) return JSON.parse(raw);}catch(e){} return STARTER; }
function saveData(d){ localStorage.setItem(LS_KEY, JSON.stringify(d)); }

/* ===== Utils ===== */
const uniq = a => Array.from(new Set(a));
const SPECIAL_ICONS = {TG:"ðŸ¦ƒ", BF:"ðŸ›", XMAS:"ðŸŽ„"};
const specialIcon = tag => SPECIAL_ICONS[tag] || "";
const weekIsSpecial = w => ["TG","XMAS"].includes(String(w));
const isTG = w => String(w)==="TG"; const isXMAS = w => String(w)==="XMAS";
const wLabel = w => isTG(w)?"Thanksgiving+BF":(isXMAS(w)?"Christmas":"W"+w);
const fmtDate = d => { try{ return new Date(d+"T00:00:00").toLocaleDateString(); }catch{ return d; } };
function weekOrder(){ return Object.keys(state.data.meta.weekDates); }
function cmpWeek(a,b){ const o=weekOrder(); return o.indexOf(String(a)) - o.indexOf(String(b)); }
function usedTeamsBeforeWeek(picks, player, week){ const idx=weekOrder().indexOf(String(week))-1; return uniq(picks.filter(p=>p.player===player && weekOrder().indexOf(String(p.week))<=idx).map(p=>p.team)); }
function usedTeamsUpTo(picks, player, week){ const idx=weekOrder().indexOf(String(week)); return uniq(picks.filter(p=>p.player===player && weekOrder().indexOf(String(p.week))<=idx).map(p=>p.team)); }
function availableForWeek(picks, player, week){ const prior=usedTeamsBeforeWeek(picks, player, week); const pool=isTG(week)?TG_BF:isXMAS(week)?XMAS:NFL; return pool.filter(t=>!prior.includes(t)); }
function entryStatus(picks, player, week){ const up=picks.filter(p=>p.player===player && cmpWeek(p.week, week)<=0).sort((a,b)=>cmpWeek(a.week,b.week)); for(const p of up){ if(p.result==="L") return {eliminated:true, reason:`Loss in ${wLabel(p.week)} (${TEAM_NAME[p.team]})`}; if(p.result==="T") return {eliminated:true, reason:`Tie in ${wLabel(p.week)} (ties = loss)`}; } return {eliminated:false, reason:""}; }
function specialUsage(used){ return {tg:used.filter(t=>TG_BF.includes(t)).length, xm:used.filter(t=>XMAS.includes(t)).length}; }

/* ===== Alerts ===== */
function thresholdAlerts(){
  const w = state.data.meta.currentWeek;
  for(const pl of state.data.players){
    const used = usedTeamsUpTo(state.data.picks, pl.name, w);
    const {tg, xm} = specialUsage(used);
    const key = s => `dn_thr_${pl.name}_${w}_${s}`;
    if(tg === TG_THRESHOLD-1 && !sessionStorage.getItem(key("tg_about"))){ alert(`Heads up: ${pl.name} is about to pass 40% TG usage (${tg}/${TG_BF.length}).`); sessionStorage.setItem(key("tg_about"),"1"); }
    if(tg >= TG_THRESHOLD   && !sessionStorage.getItem(key("tg_pass")) ){ alert(`Notice: ${pl.name} is â‰¥40% on TG usage (${tg}/${TG_BF.length}).`); sessionStorage.setItem(key("tg_pass"),"1"); }
    if(xm === XMAS_THRESHOLD-1 && !sessionStorage.getItem(key("xm_about"))){ alert(`Heads up: ${pl.name} is about to pass 40% XMAS usage (${xm}/${XMAS.length}).`); sessionStorage.setItem(key("xm_about"),"1"); }
    if(xm >= XMAS_THRESHOLD    && !sessionStorage.getItem(key("xm_pass")) ){ alert(`Notice: ${pl.name} is â‰¥40% on XMAS usage (${xm}/${XMAS.length}).`); sessionStorage.setItem(key("xm_pass"),"1"); }
  }
}

/* ===== UI Render ===== */
window.state = window.state || { data: loadData() };
const state = window.state;
if(!state.specialFocus && state.data.players.length){ state.specialFocus = state.data.players[0].name; }
if(!state.hedgePlayer && state.data.players.length){ state.hedgePlayer = state.data.players[0].name; }
if(!state.hedgeWeek){ state.hedgeWeek = String(state.data.meta.currentWeek); }
if(!state.trackerDensity){ state.trackerDensity = "compact"; }
function cellLogo(code,big=false){ return `<img class="${big?'logo-lg':'logo'}" alt="${TEAM_NAME[code]}" src="${logo(code)}">`; }

/* ===== Lines Storage (American ML) ===== */
const LS_LINES = "dn_lines_v1";
const LINES_SEED_W3 = {
  "IND@TEN": { home: "TEN", away: "IND", ml: { "IND": 140, "TEN": -165 } },
  "GB@DET":  { home: "DET", away: "GB",  ml: { "GB": 120, "DET": -140 } },
  "KC@DAL":  { home: "DAL", away: "KC",  ml: { "KC": -130, "DAL": 110 } },
  "CIN@BAL": { home: "BAL", away: "CIN", ml: { "CIN": 145, "BAL": -170 } },
  "CHI@PHI": { home: "PHI", away: "CHI", ml: { "CHI": 200, "PHI": -240 } },
  "BUF@MIA": { home: "MIA", away: "BUF", ml: { "BUF": -135, "MIA": 115 } },
  "LAR@SEA": { home: "SEA", away: "LAR", ml: { "LAR": 155, "SEA": -180 } },
  "DET@BAL": { home: "BAL", away: "DET", ml: { "DET": 165, "BAL": -195 } }
};
const LINES_DEFAULT = { "3": JSON.parse(JSON.stringify(LINES_SEED_W3)) };
function loadLines(){
  let parsed = null;
  try{
    const raw = localStorage.getItem(LS_LINES);
    if(raw) parsed = JSON.parse(raw);
  }catch{}
  const base = parsed ? parsed : JSON.parse(JSON.stringify(LINES_DEFAULT));
  if(!base["3"]){
    base["3"] = JSON.parse(JSON.stringify(LINES_SEED_W3));
  }
  return base;
}
function saveLines(obj){ localStorage.setItem(LS_LINES, JSON.stringify(obj)); }
let NFL_LINES = loadLines();
function getOpponentML(week, myTeam){
  const matchups = NFL_LINES[String(week)] || {};
  for(const key of Object.keys(matchups)){
    const game = matchups[key]; if(!game || !game.ml) continue;
    if(game.home === myTeam) return game.ml[game.away];
    if(game.away === myTeam) return game.ml[game.home];
  }
  return null;
}
const fmtML = ml => ml>0?`+${ml}`:String(ml);

function renderHeader(){
  const w = state.data.meta.currentWeek;
  document.getElementById("hdr-week").textContent = wLabel(w);
  document.getElementById("hdr-date").textContent = fmtDate(state.data.meta.weekDates[String(w)]);
  document.getElementById("year").textContent = new Date().getFullYear();
  document.getElementById("weekType").textContent = isTG(w)?"Special: Thanksgiving+BF":isXMAS(w)?"Special: Christmas":"Regular Week";
  const badgeEl = document.getElementById("env-badge");
  if(badgeEl){
    const host = location.hostname;
    if(host==="localhost" || host.startsWith("127.")){
      badgeEl.style.display = "inline-flex";
      badgeEl.textContent = "localhost preview";
    }else{
      badgeEl.style.display = "none";
    }
  }
}

function setSpecialFocus(name){
  if(!name) return false;
  if(!state.data.players.some(p=>p.name===name)) return false;
  const changed = state.specialFocus !== name;
  state.specialFocus = name;
  return changed;
}

function renderSpecialGames(){
  const wrap = document.getElementById("specialGameCards");
  if(!wrap) return;
  if(!state.data.players.length){ wrap.innerHTML = ""; return; }
  if(!state.specialFocus || !state.data.players.some(p=>p.name===state.specialFocus)){
    state.specialFocus = state.data.players[0].name;
  }
  const focus = state.specialFocus;
  const used = new Set(usedTeamsUpTo(state.data.picks, focus, state.data.meta.currentWeek));

  const groups = SPECIAL_GAME_GROUPS.map(group=>{
    const cards = group.games.map(game=>{
      const awayUsed = used.has(game.away);
      const homeUsed = used.has(game.home);
      return `
        <div class="game-card">
          <div class="game-header">
            <span class="game-icon">${specialIcon(game.tag)}</span>
            <div>
              <div>${game.date}</div>
              <div>${game.time}</div>
            </div>
          </div>
          <div class="game-body">
            <div class="game-team${awayUsed?" used":""}">${cellLogo(game.away,true)}${TEAM_NAME[game.away]}</div>
            <div class="game-at">at</div>
            <div class="game-team${homeUsed?" used":""}">${cellLogo(game.home,true)}${TEAM_NAME[game.home]}</div>
          </div>
        </div>
      `;
    }).join("");
    return `
      <div class="special-games-group">
        <div class="tiny muted" style="text-transform:uppercase;letter-spacing:.5px;">${group.title}</div>
        <div class="special-games-row">${cards}</div>
      </div>
    `;
  }).join("");

  wrap.innerHTML = `${groups}<div class="special-focus-note">Viewing availability for <strong>${focus}</strong>.</div>`;
}

function bindSpecialStatusFocus(){
  const table = document.getElementById("specialStatus");
  if(!table || table.dataset.focusBound) return;
  table.dataset.focusBound = "1";
  table.addEventListener("click", event=>{
    const control = event.target.closest(".toggle-btn, .open-panel");
    if(!control) return;
    event.preventDefault();
    const panelId = control.getAttribute("data-target") || control.getAttribute("aria-controls");
    if(!panelId) return;
    const panel = document.getElementById(panelId);
    if(!panel) return;
    const willOpen = !panel.classList.contains("open");
    panel.classList.toggle("open", willOpen);
    const player = control.dataset.player || panel.dataset.player;
    table.querySelectorAll(`[data-target="${panelId}"], [aria-controls="${panelId}"]`).forEach(btn=>{
      btn.setAttribute("aria-expanded", String(willOpen));
      if(btn.classList.contains("toggle-btn")){
        btn.innerHTML = specialPanelLabel(willOpen);
      }
      if(btn.classList.contains("open-panel")){
        btn.textContent = willOpen ? "Hide teams" : "View teams";
      }
    });
    if(player){
      const key = `open_avail_${player}`;
      if(willOpen){
        sessionStorage.setItem(key, "1");
      }else{
        sessionStorage.removeItem(key);
      }
    }
    if(willOpen){
      if(player && setSpecialFocus(player)){
        renderSpecialGames();
      }
    }
  });
}

function renderTracker(){
  const tbody = document.querySelector("#tracker tbody"); if(!tbody) return; tbody.innerHTML = "";
  const week = state.data.meta.currentWeek;
  let active = 0;

  state.data.players.forEach(pl=>{
    const picksForPlayer = state.data.picks.filter(p=>p.player===pl.name).sort((a,b)=>cmpWeek(a.week,b.week));
    const usedList = picksForPlayer.map(p=>({w:p.week,t:p.team,r:p.result||"?"}));

    const status = entryStatus(state.data.picks, pl.name, week);
    const avail  = availableForWeek(state.data.picks, pl.name, week);

    const usedUp = usedTeamsUpTo(state.data.picks, pl.name, week);
    const {tg, xm} = specialUsage(usedUp);
    const flags = [];
    if(tg === TG_THRESHOLD-1) flags.push(`<span class="chip warn tiny">about to 40% (TG)</span>`);
    if(tg >= TG_THRESHOLD)    flags.push(`<span class="chip info tiny">â‰¥40% (TG)</span>`);
    if(xm === XMAS_THRESHOLD-1) flags.push(`<span class="chip warn tiny">about to 40% (XMAS)</span>`);
    if(xm >= XMAS_THRESHOLD)    flags.push(`<span class="chip info tiny">â‰¥40% (XMAS)</span>`);

    let specialRisk = "";
    if(isTG(week) && avail.length===0) specialRisk = `<span class="chip bad tiny">No TG team left</span>`;
    if(isXMAS(week) && avail.length===0) specialRisk = `<span class="chip bad tiny">No XMAS team left</span>`;

    if(!status.eliminated) active++;

    const mini = usedList.length
      ? usedList.map(p=>`<span class="u-chip"><span class="wk">${wLabel(p.w)}</span>${cellLogo(p.t)}${TEAM_NAME[p.t]} <span class="muted">(${p.r})</span></span>`).join("")
      : "<span class='muted'>â€”</span>";

    const availChips = status.eliminated
      ? "<span class='muted tiny'>â€”</span>"
      : (avail.length? avail.map(c=>`<span class="chip">${cellLogo(c)}${TEAM_NAME[c]}</span>`).join("") : "<span class='muted tiny'>â€”</span>");

    const usedDetail = usedList.length
      ? usedList.map(p=>`<span class="chip dim">${cellLogo(p.t)}${TEAM_NAME[p.t]} <span class="muted">(${wLabel(p.w)} â€¢ ${p.r})</span></span>`).join("")
      : "<span class='muted tiny'>â€”</span>";

    const tr = document.createElement("tr");
    const panelId = `trk-${cssSafe(pl.name)}`;
    tr.innerHTML = `
      <td>
        <div class="rowline">
          <div>
            <strong>${pl.name}</strong>
            ${status.eliminated?`<span class="chip bad tiny">ELIMINATED</span>`:`<span class="chip ok tiny">ACTIVE</span>`}
            ${flags.join(" ")} ${specialRisk}
          </div>
          <div class="right-meta">
            <span class="mutey">Avail: ${status.eliminated?0:avail.length}</span>
            <button class="toggle-btn" data-player="${htmlSafe(pl.name)}" aria-expanded="false" aria-controls="${panelId}"><span class="chev">â–¸</span> Show</button>
          </div>
        </div>
        <div class="used-mini" style="margin-top:6px">${mini}</div>
        <div class="trk-panel" id="${panelId}">
          <div class="trk-grid">
            <div class="trk-col">
              <h4>Available Now</h4>
              <div class="chips">${availChips}</div>
            </div>
            <div class="trk-col">
              <h4>All Used (detail)</h4>
              <div class="chips">${usedDetail}</div>
            </div>
          </div>
        </div>
      </td>
      <td class="mono" style="text-align:right">${status.eliminated?"â€”":`${avail.length} avail`}</td>
    `;
    tbody.appendChild(tr);
  });

  document.getElementById("activeCount").textContent = `${active} active / ${state.data.players.length}`;

  tbody.querySelectorAll(".toggle-btn").forEach(btn=>{
    btn.addEventListener("click",()=>{
      const id = btn.getAttribute("aria-controls");
      const panel = document.getElementById(id);
      if(!panel) return;
      const open = btn.getAttribute("aria-expanded")==="true";
      btn.setAttribute("aria-expanded", String(!open));
      panel.classList.toggle("open", !open);
      btn.innerHTML = `<span class="chev">â–¸</span> ${!open?"Hide":"Show"}`;
    });
  });

  const dens = document.getElementById("trkDensity");
  const table = document.getElementById("tracker");
  if(dens && table){
    dens.value = state.trackerDensity || "compact";
    table.classList.toggle("trk-compact", dens.value!=="comfort");
    dens.onchange = ()=>{
      state.trackerDensity = dens.value;
      table.classList.toggle("trk-compact", dens.value!=="comfort");
    };
  }
}

function renderSpecialStatus(){
  const table = document.getElementById("specialStatus");
  if(!table) return;
  const tbody = table.querySelector("tbody");
  if(!tbody) return;
  tbody.innerHTML = "";
  const week = state.data.meta.currentWeek;

  const mkAvailChip = (code, map) => `<span class="chip logo-chip">${cellLogo(code)}${TEAM_NAME[code]} <span class="muted">(${map[code]||""})</span></span>`;
  const mkAvailList = (codes, map) => codes.length
    ? codes.map(c=>mkAvailChip(c, map)).join("")
    : `<span class="muted tiny">none</span>`;
  const mkUsedList = (picks)=> picks.length
    ? picks.map(p=>`<span class="chip logo-chip dim">${cellLogo(p.team)}${TEAM_NAME[p.team]} <span class="muted">(${wLabel(p.week)} â€¢ ${p.result || 'P'})</span></span>`).join("")
    : `<span class="muted tiny">none</span>`;

  for(const pl of state.data.players){
    const panelId = `avail-${cssSafe(pl.name)}`;
    const picksThrough = state.data.picks
      .filter(p=>p.player===pl.name && cmpWeek(p.week, week)<=0)
      .sort((a,b)=>cmpWeek(a.week,b.week));
    const usedUp = picksThrough.map(p=>p.team);
    const tg = usedUp.filter(t=>TG_BF.includes(t)).length;
    const xm = usedUp.filter(t=>XMAS.includes(t)).length;

    const tgBadge = tg>=TG_THRESHOLD?`<span class="chip info tiny">â‰¥40%</span>`:
                    tg===(TG_THRESHOLD-1)?`<span class="chip warn tiny">â†— 40% threshold</span>`:"";
    const xmBadge = xm>=XMAS_THRESHOLD?`<span class="chip info tiny">â‰¥40%</span>`:
                    xm===(XMAS_THRESHOLD-1)?`<span class="chip warn tiny">â†— 40% threshold</span>`:"";

    const tgAvail = TG_BF.filter(t=>!usedUp.includes(t));
    const xmAvail = XMAS.filter(t=>!usedUp.includes(t));
    const tgUsed = picksThrough.filter(p=>TG_BF.includes(p.team));
    const xmUsed = picksThrough.filter(p=>XMAS.includes(p.team));

    const panelTr = document.createElement("tr");
    panelTr.innerHTML = `
      <td colspan="5" style="padding-top:0;padding-bottom:0;">
        <div class="avail-panel" id="${panelId}" data-player="${htmlSafe(pl.name)}">
          <div class="avail-grid">
            <div class="avail-col">
              <h4>Thanksgiving + Black Friday (Available)</h4>
              <div class="chips">${mkAvailList(tgAvail, TG_MATCHUP_TAG)}</div>
              <div class="tiny muted" style="margin-top:6px">Used</div>
              <div class="chips">${mkUsedList(tgUsed)}</div>
            </div>
            <div class="avail-col">
              <h4>Christmas (Available)</h4>
              <div class="chips">${mkAvailList(xmAvail, XMAS_MATCHUP_TAG)}</div>
              <div class="tiny muted" style="margin-top:6px">Used</div>
              <div class="chips">${mkUsedList(xmUsed)}</div>
            </div>
          </div>
        </div>
      </td>`;

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>
        <strong>${pl.name}</strong>
        <button class="toggle-btn" type="button" data-player="${htmlSafe(pl.name)}" data-target="${panelId}" aria-expanded="false" aria-controls="${panelId}">
          ${specialPanelLabel(false)}
        </button>
      </td>
      <td class="mono">${tg}/${TG_BF.length} ${tgBadge}</td>
      <td class="tiny"><button class="link-btn open-panel" type="button" data-player="${htmlSafe(pl.name)}" data-target="${panelId}" aria-expanded="false">View teams</button></td>
      <td class="mono">${xm}/${XMAS.length} ${xmBadge}</td>
      <td class="tiny"><button class="link-btn open-panel" type="button" data-player="${htmlSafe(pl.name)}" data-target="${panelId}" aria-expanded="false">View teams</button></td>
    `;

    tbody.appendChild(tr);
    tbody.appendChild(panelTr);
  }

  tbody.querySelectorAll(".avail-panel").forEach(panel=>{
    const player = panel.dataset.player;
    if(!player) return;
    if(sessionStorage.getItem(`open_avail_${player}`)==="1"){
      panel.classList.add("open");
      table.querySelectorAll(`[data-target="${panel.id}"], [aria-controls="${panel.id}"]`).forEach(btn=>{
        btn.setAttribute("aria-expanded", "true");
        if(btn.classList.contains("toggle-btn")){
          btn.innerHTML = specialPanelLabel(true);
        }
        if(btn.classList.contains("open-panel")){
          btn.textContent = "Hide teams";
        }
      });
    }
  });
}

function specialPanelLabel(open){
  return `<span class="chev">â–¸</span><span class="tiny muted">${open?"Hide teams":"Available teams"}</span>`;
}

/* ================= Hedge Tab ================= */
function decimalsFromAmerican(american){
  if(american===null || american===undefined || american==='') return null;
  const a = Number(american);
  if(Number.isNaN(a) || a===0) return null;
  return a>0 ? 1 + a/100 : 1 + 100/Math.abs(a);
}

function renderHedgeSelectors(){
  const selP = document.getElementById("hedgePlayer");
  const selW = document.getElementById("hedgeWeek");
  if(!selP || !selW) return;
  selP.innerHTML = ""; selW.innerHTML = "";

  state.data.players.forEach(p=>{
    const opt = document.createElement("option");
    opt.value = p.name; opt.textContent = p.name;
    selP.appendChild(opt);
  });

  Object.keys(state.data.meta.weekDates).forEach(w=>{
    const opt = document.createElement("option");
    opt.value = w; opt.textContent = wLabel(w);
    selW.appendChild(opt);
  });

  const desiredWeek = state.hedgeWeek && Object.prototype.hasOwnProperty.call(state.data.meta.weekDates, state.hedgeWeek)
    ? state.hedgeWeek
    : String(state.data.meta.currentWeek);
  selW.value = desiredWeek;

  const playerExists = state.data.players.some(p=>p.name===state.hedgePlayer);
  const desiredPlayer = playerExists ? state.hedgePlayer : (state.data.players[0]?.name || "");
  if(desiredPlayer) selP.value = desiredPlayer;

  selP.onchange = ()=>{ state.hedgePlayer = selP.value; renderHedge(); };
  selW.onchange = ()=>{ state.hedgeWeek = selW.value; renderHedge(); };
}

function prettyPickRow(p){
  if(!p) return `<span class="muted">No pick for this week.</span>`;
  const badge = p.result==="W" ? `<span class="chip ok tiny">WIN</span>` :
                p.result==="L" ? `<span class="chip bad tiny">LOSS</span>` :
                p.result==="T" ? `<span class="chip bad tiny">TIE=LOSS</span>` :
                                   `<span class="chip tiny">PENDING</span>`;
  return `<div>${wLabel(p.week)} â€” ${cellLogo(p.team)}${TEAM_NAME[p.team]} ${badge}</div>`;
}

function renderHedge(){
  const selP = document.getElementById("hedgePlayer");
  const selW = document.getElementById("hedgeWeek");
  const pickBox = document.getElementById("hedgePick");
  const badges = document.getElementById("hedgeBadges");
  if(!selP || !selW || !pickBox || !badges) return;
  const name = selP.value;
  const week = selW.value;
  if(!name || !week){ pickBox.innerHTML = ""; badges.textContent = "â€”"; return; }
  state.hedgePlayer = name;
  state.hedgeWeek = week;

  const current = state.data.picks.find(p=>p.player===name && String(p.week)===String(week));
  const usedSet = usedTeamsUpTo(state.data.picks, name, week);
  const amerEl = document.getElementById("hcAmer");
  const oppML = current ? getOpponentML(week, current.team) : null;
  if(amerEl && oppML!==null){ amerEl.value = String(oppML); }

  pickBox.innerHTML = [
    `<div><strong>${name}</strong></div>`,
    prettyPickRow(current),
    `<div class="tiny muted" style="margin-top:6px">Used teams:</div>`,
    `<div class="chips">${usedSet.length? usedSet.map(t=>`<span class="chip logo-chip dim">${cellLogo(t)}${TEAM_NAME[t]}</span>`).join("") : "<span class='muted tiny'>none</span>"}</div>`
  ].join("");

  let fieldPct = null;
  if(String(week)==="3" && current){
    const status = FIELD_RESULTS_W3[current.team];
    const cnt = (FIELD_W3 && FIELD_W3[current.team])||0;
    const activeTotal = Object.entries(FIELD_W3).reduce((sum,[team,count])=>{
      if(team==="NOPICK" || FIELD_RESULTS_W3[team]==='W') return sum;
      return sum + count;
    },0) || 1;
    if(status==='W'){
      const displayML = oppML!==null ? oppML : (amerEl && amerEl.value ? Number(amerEl.value) : null);
      badges.textContent = `${TEAM_NAME[current.team]} âœ“ already won${displayML!==null?` â€¢ Opp ML: ${fmtML(displayML)}`:""}`;
    }else{
      fieldPct = Math.round((cnt/activeTotal)*1000)/10;
      const displayML = oppML!==null ? oppML : (amerEl && amerEl.value ? Number(amerEl.value) : null);
      badges.textContent = `${TEAM_NAME[current.team]} field: ${fieldPct}%${displayML!==null?` â€¢ Opp ML: ${fmtML(displayML)}`:""}`;
    }
  }else if(fieldPct===null){
    const displayML = oppML!==null ? oppML : (amerEl && amerEl.value ? Number(amerEl.value) : null);
    badges.textContent = displayML!==null ? `Opp ML: ${fmtML(displayML)}` : "â€”";
  }

  const warn = document.getElementById("hcWarn");
  if(warn){ warn.textContent = ""; warn.className = "note"; }

  renderHedgeCalc();
}

function renderHedgeCalc(){
  const amerEl = document.getElementById("hcAmer");
  const stakeEl = document.getElementById("hcStake");
  const pEl = document.getElementById("hcPwin");
  const eqEl = document.getElementById("hcEquity");
  const warn = document.getElementById("hcWarn");
  const tbody = document.querySelector("#hcTable tbody");
  if(!stakeEl || !pEl || !tbody) return;

  const decimal = Math.max(1.01, decimalsFromAmerican(amerEl?.value) || 2.20);
  const stake = Math.max(0, Number(stakeEl.value)||0);
  const pWin = Math.min(0.99, Math.max(0.01, (Number(pEl.value)||60)/100));
  const equity = Math.max(0, Number(eqEl?.value)||0);
  const buyIn = Math.max(0, Number(document.getElementById("hcBuyin")?.value)||0);

  if(warn && !warn.textContent){ warn.className = "note"; }

  if(amerEl && (!amerEl.value || amerEl.value==="0")){
    const american = decimal>=2 ? Math.round((decimal-1)*100) : Math.round(-100/(decimal-1));
    amerEl.placeholder = fmtML(american);
  }

  const netWin = -stake;
  const netLose = stake*(decimal-1);
  const afterWin = (equity - stake) - buyIn;
  const afterLose = netLose - buyIn;
  const evHedge = pWin*netWin + (1-pWin)*netLose;
  const evWin = pWin * afterWin;
  const evLose = (1-pWin) * afterLose;
  const evTotal = evWin + evLose;
  const floorEqualize = equity ? equity*(decimal-1)/decimal : null;

  const fmtMoney = val => {
    if(!Number.isFinite(val)) return "â€”";
    const abs = Math.abs(val).toFixed(2);
    const sign = val>0?"+":val<0?"-":"";
    return `${sign}$${abs}`;
  };
  const classFor = val => val>0?"profit":val<0?"loss":"";

  tbody.innerHTML = `
    <tr>
      <td>Your pick <strong>WINS</strong></td>
      <td class="mono">${fmtMoney(netWin)}</td>
      <td class="mono ${classFor(afterWin)}">${fmtMoney(afterWin)}</td>
      <td class="mono ${classFor(evWin)}">${fmtMoney(evWin)}</td>
    </tr>
    <tr>
      <td>Your pick <strong>LOSES</strong></td>
      <td class="mono">${fmtMoney(netLose)}</td>
      <td class="mono ${classFor(afterLose)}">${fmtMoney(afterLose)}</td>
      <td class="mono ${classFor(evLose)}">${fmtMoney(evLose)}</td>
    </tr>
    <tr>
      <td class="tiny muted">Expected Value (overall)</td>
      <td class="mono ${classFor(evHedge)}">${fmtMoney(evHedge)}</td>
      <td class="mono ${classFor(evTotal)}">${fmtMoney(evTotal)}</td>
      <td class="mono ${classFor(evTotal)}">${fmtMoney(evTotal)}</td>
    </tr>
    ${floorEqualize!==null?`<tr><td class="tiny muted">Equalized floor reference</td><td></td><td class="tiny muted">â‰ˆ $${floorEqualize.toFixed(2)}</td><td></td></tr>`:""}
  `;
}

function bindHedgeCalcInputs(){
  const ids = ["hcAmer","hcStake","hcPwin","hcEquity","hcBuyin","hcFloor","hcProfit"];
  const warn = document.getElementById("hcWarn");
  const amerEl = document.getElementById("hcAmer");
  const stakeEl = document.getElementById("hcStake");
  const eqEl = document.getElementById("hcEquity");
  const floorEl = document.getElementById("hcFloor");
  const buyEl = document.getElementById("hcBuyin");
  const profitEl = document.getElementById("hcProfit");
  const cleanWarn = (msg="")=>{
    if(!warn) return;
    warn.textContent = msg;
    warn.className = msg?"note warn":"note";
  };
  const handleInput = ()=>{ cleanWarn(); renderHedgeCalc(); };
  ids.forEach(id=>{
    const el = document.getElementById(id);
    if(el) el.addEventListener("input", handleInput);
  });

  const eqBtn = document.getElementById("btnEqualize");
  const targetBtn = document.getElementById("btnTarget");
  const lockBtn = document.getElementById("btnLock");
  const profitBtn = document.getElementById("btnProfit");

  const decimalValue = ()=>Math.max(1.01, decimalsFromAmerican(amerEl?.value) || 2.20);
  const equityValue = ()=>Math.max(0, Number(eqEl?.value)||0);
  const applyFloorTarget = (floorTarget, label)=>{
    const decimal = decimalValue();
    const equity = equityValue();
    const maxFloor = equity*(decimal-1)/decimal;
    if(floorTarget > maxFloor + 1e-6){
      cleanWarn(`${label} $${floorTarget.toFixed(2)} not feasible. Max floor â‰ˆ $${maxFloor.toFixed(2)}.`);
      return false;
    }
    const minStake = floorTarget/(decimal-1);
    const maxStake = Math.max(0, equity - floorTarget);
    if(minStake > maxStake + 1e-6){
      cleanWarn(`${label} $${floorTarget.toFixed(2)} not feasible. Max floor â‰ˆ $${maxFloor.toFixed(2)}.`);
      return false;
    }
    const stake = Math.min(Math.max(minStake, 0), maxStake);
    if(stakeEl){ stakeEl.value = stake.toFixed(2); }
    cleanWarn(`${label} $${floorTarget.toFixed(2)} locked with min stake â‰ˆ $${stake.toFixed(2)} (max floor â‰ˆ $${maxFloor.toFixed(2)}).`);
    renderHedgeCalc();
    return true;
  };

  eqBtn?.addEventListener("click", ()=>{
    const decimal = decimalValue();
    const equity = equityValue();
    const stake = equity / decimal;
    if(stakeEl){ stakeEl.value = stake.toFixed(2); }
    const floor = equity*(decimal-1)/decimal;
    cleanWarn(`Equalize: play â‰ˆ $${stake.toFixed(2)} to lock floor â‰ˆ $${floor.toFixed(2)}.`);
    renderHedgeCalc();
  });

  targetBtn?.addEventListener("click", ()=>{
    const floorTarget = Math.max(0, Number(floorEl?.value)||0);
    applyFloorTarget(floorTarget, "Target floor");
  });

  lockBtn?.addEventListener("click", ()=>{
    const buyIn = Math.max(0, Number(buyEl?.value)||0);
    if(applyFloorTarget(buyIn, "Lock Buy-In")){ /* already handled */ }
  });

  profitBtn?.addEventListener("click", ()=>{
    const buyIn = Math.max(0, Number(buyEl?.value)||0);
    const profit = Math.max(0, Number(profitEl?.value)||0);
    const floorTarget = buyIn + profit;
    applyFloorTarget(floorTarget, "Lock Profit");
  });
}

/* ===== Rooting Guide (Week 3 field data) ===== */
const FIELD_W3 = {
  SEA:6655, BUF:3362, TB:2033, GB:1817, ATL:1179, IND:714, KC:676, MIN:102, WAS:96,
  SF:67, LAC:52, HOU:49, DAL:43, BAL:30, PIT:20, CHI:13, NE:11, JAX:9, LV:4,
  CAR:3, TEN:2, LAR:2, NO:2, MIA:1, ARI:1, NOPICK:13
};
const FIELD_RESULTS_W3 = { BUF: "W" };
const FIELD_W3_TOTAL = Object.values(FIELD_W3).reduce((sum,val)=>sum+val,0);

function groupWeekExposure(week){
  const exp = {};
  for(const pick of state.data.picks){
    if(String(pick.week)!==String(week)) continue;
    exp[pick.team] = (exp[pick.team]||0)+1;
  }
  return exp;
}

function leverageList(week, fieldOverride=null, statusOverride={}){
  const field = fieldOverride || (week===3 ? FIELD_W3 : null);
  if(!field) return [];
  const status = statusOverride || {};
  const entries = Object.entries(field).filter(([team,count])=> team!=="NOPICK" && status[team] !== "W" && count>0);
  const totalField = entries.reduce((sum,[,count])=>sum+count,0) || 1;
  const group = groupWeekExposure(week);
  const rows = [];
  entries.forEach(([team, fieldCount])=>{
    const fieldPct = fieldCount / totalField;
    const groupCount = group[team] || 0;
    rows.push({
      outcome: `${TEAM_NAME[team]} lose`,
      fieldImpact: fieldPct,
      groupExposure: groupCount,
      why: groupCount===0 ? "We faded this chalk â€” full leverage" : "Field loses big; we drop some too"
    });
    rows.push({
      outcome: `${TEAM_NAME[team]} win`,
      fieldImpact: -fieldPct,
      groupExposure: groupCount,
      why: groupCount>0 ? "We stay alive with the crowd; low leverage" : "Field keeps equity while we still chase"
    });
  });
  rows.sort((a,b)=>b.fieldImpact - a.fieldImpact);
  return rows.slice(0,6);
}

function renderRooting(){
  const w = state.data.meta.currentWeek;
  const weekLabel = wLabel(w);
  const weekNode = document.getElementById("root-week");
  if(weekNode) weekNode.textContent = weekLabel;

  const rawField = w===3 ? FIELD_W3 : null;
  const fieldStatus = w===3 ? FIELD_RESULTS_W3 : {};
  const field = rawField ? {...rawField} : null;
  if(field){
    Object.entries(fieldStatus).forEach(([team,res])=>{ if(res==='W') field[team] = 0; });
  }
  const groupExp = groupWeekExposure(w);
  const groupSize = state.data.players.length || 0;

  let chalkTeam = null;
  if(field){
    for(const [team,count] of Object.entries(field)){
      if(team === "NOPICK" || fieldStatus[team]==='W' || count<=0) continue;
      if(chalkTeam===null || count > field[chalkTeam]) chalkTeam = team;
    }
  }

  const chalkGroupCount = chalkTeam ? (groupExp[chalkTeam]||0) : 0;
  const activeTotal = field ? Object.entries(field).reduce((sum,[team,count])=>{
    if(team==="NOPICK" || fieldStatus[team]==='W') return sum;
    return sum + count;
  },0) || 1 : 1;
  const chalkFieldPct = chalkTeam && field ? field[chalkTeam] / activeTotal : 0;

  const chalkNode = document.getElementById("kpi-chalk");
  const fieldNode = document.getElementById("kpi-field");
  const chalkLoseNode = document.getElementById("kpi-chalklose");
  if(chalkNode) chalkNode.textContent = chalkTeam ? `${chalkGroupCount}/${groupSize} on ${TEAM_NAME[chalkTeam]}` : "n/a";
  if(fieldNode) fieldNode.textContent = chalkTeam ? `${TEAM_NAME[chalkTeam]} â€” ${(chalkFieldPct*100).toFixed(1)}%` : "n/a";
  if(chalkLoseNode) chalkLoseNode.textContent = chalkTeam ? `${(chalkFieldPct*100).toFixed(1)}%` : "n/a";

  const tbody = document.querySelector("#root-table tbody");
  if(tbody){
    tbody.innerHTML = "";
    leverageList(w, field, fieldStatus).forEach(row=>{
      const pct = (row.fieldImpact*100).toFixed(1);
      const pctNum = parseFloat(pct);
      const tr = document.createElement("tr");
      if(row.groupExposure>0) tr.classList.add("used");
      tr.innerHTML = `
        <td>${row.outcome}</td>
        <td class="mono ${pctNum>0?'badge-good':pctNum<0?'badge-bad':''}">${pctNum>0?'+':''}${pct}</td>
        <td class="mono">${row.groupExposure||0}</td>
        <td class="tiny muted">${row.why}</td>
      `;
      tbody.appendChild(tr);
    });
  }

  const panel = document.getElementById("ifttt");
  if(panel){
    if(!field){
      panel.innerHTML = `<span class="muted tiny">No field data loaded for ${weekLabel} yet.</span>`;
    }else{
      const lines = [];
      if(chalkTeam){
        lines.push(`IF <strong>${TEAM_NAME[chalkTeam]}</strong> <span class="badge-bad">lose</span> THEN <span class="badge-good">${(chalkFieldPct*100).toFixed(0)}%</span> of field drops ${chalkGroupCount?`(we lose ${chalkGroupCount}).`:`(we lose 0).`}`);
      }
      let maxEntryTeam = null;
      let maxEntryCount = -1;
      for(const [team,count] of Object.entries(groupExp)){
        if(count > maxEntryCount){
          maxEntryCount = count;
          maxEntryTeam = team;
        }
      }
      if(maxEntryTeam){
        const fieldPct = field[maxEntryTeam]? (field[maxEntryTeam]/activeTotal)*100 : 0;
        lines.push(`IF <strong>${TEAM_NAME[maxEntryTeam]}</strong> <span class="badge-bad">lose</span> THEN <strong>${maxEntryCount}</strong> of our entries out (field hit ~${fieldPct.toFixed(0)}%).`);
      }
      let bestFadeTeam = null;
      let bestFadePct = -1;
      if(field){
        for(const [team,count] of Object.entries(field)){
          if(team === "NOPICK" || fieldStatus[team]==='W') continue;
          if((groupExp[team]||0)===0){
            const pct = count / activeTotal;
            if(pct > bestFadePct){
              bestFadePct = pct;
              bestFadeTeam = team;
            }
          }
        }
      }
      if(bestFadeTeam){
        lines.push(`IF <strong>${TEAM_NAME[bestFadeTeam]}</strong> <span class="badge-bad">lose</span> THEN max leverage for us (0 group risk; field -${(bestFadePct*100).toFixed(0)}%).`);
      }
      const playedWins = Object.entries(fieldStatus).filter(([,res])=>res==='W');
      const decidedEntries = Array.from(new Set(state.data.picks.filter(p=>String(p.week)==='3' && fieldStatus[p.team]==='W').map(p=>p.player)));
      const decidedNote = playedWins.length
        ? `<div class="tiny muted">Already decided: ${playedWins.map(([team])=>`${TEAM_NAME[team]} âœ“`).join(", ")} ${decidedEntries.length?`(secured for ${decidedEntries.join(", ")})`:""}. Impact removed from leverage.</div>`
        : "";
      panel.innerHTML = (lines.length? lines.map(line=>`<div class="tiny">${line}</div>`).join("") : `<span class="muted tiny">No leverage scenarios available.</span>`) + decidedNote;
    }
  }
}

function cssSafe(s){ return String(s).toLowerCase().replace(/[^a-z0-9]+/g,"-"); }
function htmlSafe(s){ return String(s).replace(/&/g,"&amp;").replace(/</g,"&lt;"); }

/* ===== Make Picks Panel ===== */
function renderPickSelectors(){
  const weekSel = document.getElementById("pickWeek");
  const playerSel = document.getElementById("pickPlayer");
  const teamSel = document.getElementById("pickTeam");
  weekSel.innerHTML = ""; playerSel.innerHTML = ""; teamSel.innerHTML = "";

  for(const w of weekOrder()){
    const opt = document.createElement("option"); opt.value = w; opt.textContent = wLabel(w);
    if(String(w)===String(state.data.meta.currentWeek)) opt.selected = true;
    weekSel.appendChild(opt);
  }
  for(const p of state.data.players){
    const opt = document.createElement("option"); opt.value = p.name; opt.textContent = p.name;
    playerSel.appendChild(opt);
  }
  const refreshTeams = ()=>{
    const w = weekSel.value; const name = playerSel.value;
    const avail = availableForWeek(state.data.picks, name, w);
    teamSel.innerHTML = "";
    avail.forEach(c=>{ const opt = document.createElement("option"); opt.value=c; opt.textContent=TEAM_NAME[c]; teamSel.appendChild(opt); });
    const tiles = document.getElementById("availabilityTiles");
    tiles.innerHTML = NFL.map(code=>{
      const used = usedTeamsBeforeWeek(state.data.picks, name, w).includes(code);
      const inPool = isTG(w)? TG_BF.includes(code) : isXMAS(w)? XMAS.includes(code) : true;
      return `<div class="tile ${used||!inPool?'used':''}">${cellLogo(code,true)}${TEAM_NAME[code]}</div>`;
    }).join("");
  };
  weekSel.onchange = refreshTeams; playerSel.onchange = refreshTeams; refreshTeams();

  document.getElementById("savePick").onclick = ()=>{
    const w = isNaN(Number(weekSel.value)) ? weekSel.value : Number(weekSel.value);
    const name = playerSel.value; const team = teamSel.value;
    if(!team){ alert("No team available for that entry/week."); return; }
    if(state.data.picks.find(p=>String(p.week)===String(w) && p.player===name)){ alert("This entry already has a pick for that week."); return; }
    state.data.picks.push({week:w, player:name, team, result:"P"});
    saveData(state.data); sessionStorage.clear(); renderAll();
  };
}

/* ===== Week controls & init ===== */
function renderWeekSelects(){
  const sel = document.getElementById("weekSelect"); sel.innerHTML = "";
  for(const w of weekOrder()){
    const opt = document.createElement("option"); opt.value = w; opt.textContent = wLabel(w);
    if(String(w)===String(state.data.meta.currentWeek)) opt.selected = true;
    sel.appendChild(opt);
  }
  sel.onchange = ()=>{ state.data.meta.currentWeek = isNaN(Number(sel.value))? sel.value : Number(sel.value); saveData(state.data); renderAll(); };
  document.getElementById("advanceWeek").onclick = ()=>{
    const order = weekOrder(); const idx = order.indexOf(String(state.data.meta.currentWeek));
    state.data.meta.currentWeek = order[Math.min(order.length-1, idx+1)]; saveData(state.data); renderAll();
  };
}

function renderAll(){
  renderHeader();
  renderWeekSelects();
  renderTracker();
  renderSpecialStatus();
  bindSpecialStatusFocus();
  const fallback = state.data.players.find(p=>p.name===state.specialFocus)?.name || state.data.players[0]?.name || "";
  if(fallback) setSpecialFocus(fallback);
  renderSpecialGames();
  renderPickSelectors();
  renderHedgeSelectors();
  renderHedge();
  renderRooting();
  document.getElementById("dataEditor").value = JSON.stringify(state.data, null, 2);
  thresholdAlerts();
}
function showTab(id){
  ["overview","rooting","hedge"].forEach(tab=>{
    document.getElementById("tab-"+tab)?.classList.toggle("active", tab===id);
    document.querySelector(`.tabbtn[data-tab="${tab}"]`)?.classList.toggle("active", tab===id);
  });
}
function initTabs(){
  document.querySelectorAll(".tabbtn").forEach(btn=>{
    btn.addEventListener("click",()=>{
      if(btn.dataset.tab) showTab(btn.dataset.tab);
    });
  });
}

function initLinesEditor(){
  const editor = document.getElementById("linesEditor");
  const apply = document.getElementById("applyLines");
  const reset = document.getElementById("resetLines");
  if(!editor || !apply || !reset) return;
  editor.value = Object.keys(NFL_LINES||{}).length ? JSON.stringify(NFL_LINES, null, 2) : "";
  apply.addEventListener("click",()=>{
    try{
      const raw = editor.value.trim();
      NFL_LINES = raw ? JSON.parse(raw) : {};
      saveLines(NFL_LINES);
      editor.value = raw ? JSON.stringify(NFL_LINES, null, 2) : "";
      renderHedge();
      alert("Lines saved.");
    }catch(e){ alert("Invalid JSON: "+ e.message); }
  });
  reset.addEventListener("click",()=>{
    NFL_LINES = {};
    saveLines(NFL_LINES);
    editor.value = "";
    renderHedge();
  });
}

document.addEventListener("DOMContentLoaded", ()=>{
  initTabs();
  bindHedgeCalcInputs();
  initLinesEditor();
  showTab("overview");
  renderAll();
});
</script>
</body>
</html>
